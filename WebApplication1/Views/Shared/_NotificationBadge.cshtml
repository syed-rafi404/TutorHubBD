@using Microsoft.AspNetCore.Identity
@using TutorHubBD.Web.Models
@inject SignInManager<ApplicationUser> SignInManager

@if (SignInManager.IsSignedIn(User))
{
    <li class="nav-item dropdown">
        <a class="nav-link dropdown-toggle position-relative" href="#" id="notificationDropdown" role="button" 
           data-bs-toggle="dropdown" aria-expanded="false" onclick="loadNotifications()">
            <i class="bi bi-bell"></i>
            <span id="notificationBadge" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" style="display: none;">
                0
            </span>
        </a>
        <ul class="dropdown-menu dropdown-menu-end notification-dropdown" aria-labelledby="notificationDropdown" style="width: 320px; max-height: 400px; overflow-y: auto;">
            <li class="dropdown-header d-flex justify-content-between align-items-center">
                <span><strong>Notifications</strong></span>
                <a href="#" onclick="markAllAsRead()" class="text-decoration-none small">Mark all as read</a>
            </li>
            <li><hr class="dropdown-divider"></li>
            <div id="notificationList">
                <li class="text-center py-3 text-muted">
                    <i class="bi bi-bell-slash"></i> No new notifications
                </li>
            </div>
            <li><hr class="dropdown-divider"></li>
            <li class="text-center">
                <a href="/Notification/Index" class="dropdown-item text-primary">View All Notifications</a>
            </li>
        </ul>
    </li>
}

<style>
    .notification-dropdown .dropdown-item {
        white-space: normal;
        padding: 10px 15px;
    }
    .notification-dropdown .notification-item {
        border-left: 3px solid #0d6efd;
        background-color: #f8f9fa;
    }
    .notification-dropdown .notification-item.read {
        border-left-color: #6c757d;
        background-color: white;
    }
    .notification-dropdown .notification-title {
        font-weight: 600;
        font-size: 0.9rem;
        margin-bottom: 2px;
    }
    .notification-dropdown .notification-message {
        font-size: 0.8rem;
        color: #6c757d;
        margin-bottom: 2px;
    }
    .notification-dropdown .notification-time {
        font-size: 0.7rem;
        color: #adb5bd;
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        updateNotificationBadge();
        setInterval(updateNotificationBadge, 30000);
    });

    function updateNotificationBadge() {
        fetch('/Notification/GetUnreadCount')
            .then(response => response.json())
            .then(data => {
                const badge = document.getElementById('notificationBadge');
                if (data.count > 0) {
                    badge.textContent = data.count > 99 ? '99+' : data.count;
                    badge.style.display = 'inline';
                } else {
                    badge.style.display = 'none';
                }
            })
            .catch(error => console.error('Error fetching notification count:', error));
    }

    function loadNotifications() {
        fetch('/Notification/GetUnreadNotifications')
            .then(response => response.json())
            .then(data => {
                const list = document.getElementById('notificationList');
                if (data.notifications && data.notifications.length > 0) {
                    list.innerHTML = data.notifications.map(n => `
                        <li>
                            <a class="dropdown-item notification-item" href="/Notification/Click/${n.id}">
                                <div class="notification-title">${escapeHtml(n.title)}</div>
                                <div class="notification-message">${escapeHtml(n.message)}</div>
                                <div class="notification-time">${n.createdAt}</div>
                            </a>
                        </li>
                    `).join('');
                } else {
                    list.innerHTML = `
                        <li class="text-center py-3 text-muted">
                            <i class="bi bi-bell-slash"></i> No new notifications
                        </li>
                    `;
                }
            })
            .catch(error => console.error('Error loading notifications:', error));
    }

    function markAllAsRead() {
        fetch('/Notification/MarkAllAsRead', { method: 'POST' })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    updateNotificationBadge();
                    loadNotifications();
                }
            })
            .catch(error => console.error('Error marking notifications as read:', error));
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
</script>
